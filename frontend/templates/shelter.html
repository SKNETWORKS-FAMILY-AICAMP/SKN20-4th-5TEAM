{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가까운 대피소 찾기 챗봇</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Naver Maps API (2026-01-06: 주석 처리) -->
    <!-- <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ naver_map_client_id }}&submodules=panorama,geocoder" defer></script> -->

    <!-- Kakao Maps API (2026-01-06 추가) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_map_api_key }}&libraries=services"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/shelter.css' %}">
</head>

<body class="h-screen w-screen overflow-hidden bg-gray-100 flex items-center justify-center p-4 md:p-8 md:px-[5%]">

    <div
        class="relative w-full h-full bg-white shadow-2xl rounded-[2.5rem] overflow-hidden flex flex-col md:flex-row border border-gray-200">

        <!-- [2026-01-08 수정] 동영상 영역이 채팅창 창까지 덮도록 최상위 컨테이너로 이동 -->
        <div id="video-overlay" class="absolute inset-0 z-[200] bg-black hidden flex-col">
            <div
                class="flex-shrink-0 bg-gray-900 p-4 flex justify-between items-center text-white border-b border-gray-700">
                <span class="font-bold text-2xl flex items-center gap-2 pt-1"><span class="walking-icon">🎥</span> 실시간
                    재난 안내 영상</span>
                <button onclick="closeVideoOverlay()"
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-xl font-bold text-lg transition-all shadow-lg border-2 border-white/20">✕
                    영상 닫기</button>
            </div>
            <div class="flex-1 bg-black overflow-hidden flex items-center justify-center">
                <!-- [2026-01-08 수정] 초기 src를 비워두어 배경 로딩 방지 -->
                <iframe id="video-iframe" class="w-full h-full" title="YouTube video player" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
        </div>

        <!-- left : map + panorama (7 비율) -->
        <div class="flex flex-col bg-gray-200 h-full md:flex-[7] min-w-0">
            <header class="flex-shrink-0 p-4 bg-red-600 text-white flex justify-between items-center shadow-md">
                <div>
                    <h1 class="text-2xl font-black"><span class="siren-icon">🚨</span> 재난 안전 챗봇</h1>
                    <p class="text-sm opacity-90 font-medium">민방위대피시설 정보 기반</p>
                </div>
                <div id="llm-status" class="llm-badge llm-off">LLM OFF</div>
            </header>

            <!-- 지도 영역 -->
            <div class="relative flex-1 min-h-0 overflow-hidden">
                <div id="map" class="w-full h-full transition-all duration-300"></div>

                <!-- [2026-01-08 수정] 모든 버튼이 한 줄(Single Row)에 위치하도록 수정 -->
                <div class="absolute top-6 left-0 right-0 z-[110] flex justify-center pointer-events-none">
                    <div class="flex gap-2 px-6 overflow-x-auto no-scrollbar pointer-events-auto max-w-full">
                        <!-- [2026-01-08 수정] 모델 필드명 불일치 수정 (name -> disaster_kind, video_url -> youtube_link) -->
                        {% for item in disaster_videos %}
                        <button onclick="handleCategorySearch('{{ item.disaster_kind }}', '{{ item.youtube_link }}')"
                            class="map-category-btn">{{ item.disaster_kind }}</button>
                        {% endfor %}
                        <!-- [2026-01-08 수정] 커스텀 지진 아이콘 적용 및 재난 카테고리 정리 -->
                        <!-- <button onclick="handleCategorySearch('지진')" class="map-category-btn">
                            <img src="/static/images/earthquake_icon.png" alt="지진"> 지진
                        </button>
                        <button onclick="handleCategorySearch('홍수')" class="map-category-btn">🌊 홍수</button>
                        <button onclick="handleCategorySearch('산사태')" class="map-category-btn">⛰️ 산사태</button>
                        <button onclick="handleCategorySearch('호우')" class="map-category-btn">🌧️ 호우</button>
                        <button onclick="handleCategorySearch('해일')" class="map-category-btn">🌊 해일</button>
                        <button onclick="handleCategorySearch('태풍')" class="map-category-btn">🌀 태풍</button>
                        <button onclick="handleCategorySearch('화산재')" class="map-category-btn">🌋 화산재</button>
                        <button onclick="handleCategorySearch('화산폭발')" class="map-category-btn">🔥 화산폭발</button>
                        <button onclick="handleCategorySearch('댐붕괴')" class="map-category-btn">🏗️ 댐붕괴</button>
                        <button onclick="handleCategorySearch('화재')" class="map-category-btn">🔥 화재</button>
                        <button onclick="handleCategorySearch('폭발')" class="map-category-btn">💥 폭발</button>
                        <button onclick="handleCategorySearch('원전사고')" class="map-category-btn">☢️ 원전사고</button>
                        <button onclick="handleCategorySearch('산불')" class="map-category-btn">🌲 산불</button> -->
                    </div>
                </div>


                <!-- [2026-01-06 추가] 슬라이딩 패널 토글 버튼 (지도 위에 고정) -->
                <button id="nav-toggle-btn" onclick="toggleNavDrawer()"
                    class="absolute top-6 left-6 z-[110] bg-emerald-600 hover:bg-emerald-700 text-white w-20 h-20 rounded-full shadow-2xl flex items-center justify-center text-5xl transition-all border-4 border-white hidden"
                    title="길찾기 상세 안내 보기">
                    🛣️
                </button>

                <!-- [2026-01-06 추가] 슬라이딩 패널 (Drawer) - [2026-01-08 z-index 상향] -->
                <div id="nav-drawer"
                    class="absolute top-0 left-0 z-[150] h-full w-[576px] bg-white/95 backdrop-blur-md shadow-2xl border-r border-gray-200 transform -translate-x-full transition-transform duration-300 flex flex-col">

                    <div
                        class="p-5 border-b border-gray-200 bg-emerald-600 text-white flex justify-between items-center">
                        <h3 class="font-bold text-2xl text-white"><span class="walking-icon">🚶</span> 길찾기 상세 안내</h3>
                        <button onclick="toggleNavDrawer()"
                            class="text-white hover:text-gray-200 text-3xl leading-none px-2">&times;</button>
                    </div>

                    <div id="nav-summary"
                        class="p-5 bg-emerald-50 border-b border-gray-100 text-xl font-bold text-center text-emerald-800 flex justify-around">
                        <p>경로 데이터를 불러오는 중...</p>
                    </div>

                    <div id="nav-list" class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                        <div class="text-center text-gray-400 py-20 text-sm">
                            <p><span class="walking-icon">🏃</span> 대피소 검색 시 자동으로 안내가 시작됩니다.</p>
                        </div>
                    </div>

                    <!-- [2026-01-09 수정] 광고판 영역을 원래 위치(길찾기 상세 안내 하단)로 복원 -->
                    <div class="flex-shrink-0 bg-gray-50 border-t border-gray-100 h-[180px] relative overflow-hidden"
                        id="ad-container">
                        <div class="absolute top-2 left-3 z-[100]">
                            <span
                                class="text-[9px] bg-black/10 text-gray-500 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">AD</span>
                        </div>

                        <div class="w-full h-full relative" id="ad-wrapper">
                            {% for ad in advertisements %}
                            <div class="ad-slide absolute inset-0 flex items-center justify-center transition-opacity duration-1000"
                                style="opacity: {% if forloop.first %}1{% else %}0{% endif %}; pointer-events: {% if forloop.first %}auto{% else %}none{% endif %}; z-index: {% if forloop.first %}10{% else %}0{% endif %}; display: flex;"
                                data-index="{{ forloop.counter0 }}" data-name="{{ ad.ad_kind }}">
                                {% if ad.image_filename %}
                                <img src="{% static 'images/ad_images/' %}{{ ad.image_filename }}"
                                    class="absolute inset-0 w-full h-full object-cover blur-3xl opacity-30 scale-125">
                                <img src="{% static 'images/ad_images/' %}{{ ad.image_filename }}"
                                    alt="{{ ad.ad_kind }}" class="relative z-[10] w-full h-full object-contain p-2">
                                {% endif %}
                            </div>
                            {% empty %}
                            <div class="flex items-center justify-center h-full">
                                <p class="text-xl font-bold text-gray-300">안전한 하루 되세요!</p>
                            </div>
                            {% endfor %}
                            <!-- 하단 상태 표시줄 (백그라운드에서 로직이 도는 것을 눈으로 확인용) -->
                            <div id="ad-rotation-status"
                                class="absolute bottom-1 right-2 text-[9px] bg-black/20 text-white/70 px-1.5 py-0.5 rounded-full z-[120] pointer-events-none font-mono">
                                연동 대기 중...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 파노라마(로드뷰) 영역 (2026-01-06: 구조 개선) -->
            <div id="pano-container" class="w-full bg-gray-800 relative transition-all duration-300"
                style="height: 0%; overflow: hidden;">
                <!-- 실제 로드뷰가 그려질 영역 -->
                <div id="pano" class="w-full h-full"></div>

                <!-- 안내 및 컨트롤 레이어 (로드뷰 위에 덮어씌움) -->
                <div id="pano-placeholder"
                    class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm z-10">
                    📷 지도를 클릭하면 로드뷰가 표시됩니다
                </div>
                <button id="pano-close-btn" onclick="hidePanorama()"
                    class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg shadow-xl z-50 hidden transition-all"
                    title="로드뷰 닫기">
                    ✕ 닫기
                </button>
            </div>
        </div>

        <!-- right : chat (3 비율) -->
        <div class="flex flex-col h-full bg-white border-l border-gray-200 md:flex-[3] min-w-0">
            <div id="chat-window" class="flex-1 min-h-0 p-6 space-y-4 overflow-y-auto bg-white">
                <div class="flex justify-start mb-6 px-2 group items-start gap-3">
                    <div class="flex-shrink-0 w-12 h-12 rounded-2xl overflow-hidden shadow-lg bg-white">
                        <img src="/static/images/bot2.png" class="w-full h-full object-cover" alt="Bot Avatar">
                    </div>
                    <div
                        class="bg-white text-gray-800 p-4 rounded-3xl rounded-tl-none max-w-[80%] shadow-lg border border-gray-100">
                        <p class="font-bold text-emerald-600 mb-1 flex items-center gap-2">🛡️ 대피소 도우미</p>
                        <p id="initial-message">대피소 데이터를 로드하는 중입니다. 잠시만 기다려 주세요...</p>
                    </div>
                </div>
            </div>

            <!-- control panel -->
            <div id="control-panel"
                class="flex-shrink-0 p-4 bg-gray-50 border-t border-gray-300 flex flex-col gap-3 shadow-md">
                <div class="flex gap-2">
                    <button id="geo-btn" onclick="handleGeolocation()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl disabled-control"
                        disabled>📍 현위치로 찾기 (GPS)</button>
                    <button id="clear-btn" onclick="clearChatWindow()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold px-4 py-3 rounded-xl"
                        title="채팅 기록 지우기">🗑️</button>
                </div>

                <div class="flex gap-2">
                    <input id="chat-input" type="text" placeholder="주소 / 건물명 / '현위치' 입력"
                        class="flex-grow border border-gray-300 rounded-xl p-3 focus:ring-emerald-500 focus:border-emerald-500"
                        onkeydown="if(event.key==='Enter') handleChatInput()" disabled>
                    <button id="send-btn" onclick="handleChatInput()"
                        class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-4 rounded-xl disabled-control"
                        disabled>전송</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2026-01-06: 접속 경로(hostname)에 따라 백엔드 주소 자동 설정 로직 추가 (기존 방식은 주석 처리) -->
    <script>
        // window.FASTAPI_URL = "{{ fastapi_url }}"; // 기존: Django에서 주입받던 방식
        const currentHost = window.location.hostname;
        window.FASTAPI_URL = `http://${currentHost}:8001`;
        console.log("백엔드 연결 주소:", window.FASTAPI_URL);
    </script>

    <!-- Custom JavaScript -->
    <script src="{% static 'js/shelter.js' %}"></script>

</body>

</html>