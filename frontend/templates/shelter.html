{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가까운 대피소 찾기 챗봇</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Naver Maps API (2026-01-06: 주석 처리) -->
    <!-- <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ naver_map_client_id }}&submodules=panorama,geocoder" defer></script> -->

    <!-- Kakao Maps API (2026-01-06 추가) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_map_api_key }}&libraries=services"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/shelter.css' %}">
</head>

<body class="min-h-screen flex items-center justify-center p-2 md:p-6">

    <div class="w-full max-w-6xl bg-white shadow-2xl rounded-2xl overflow-hidden grid md:grid-cols-2">

        <!-- left : map + panorama -->
        <div class="flex flex-col bg-gray-200 h-[250px] md:h-[85vh]">
            <header class="flex-shrink-0 p-4 bg-red-600 text-white flex justify-between items-center shadow-md">
                <div>
                    <h1 class="text-lg font-bold">🚨 재난 안전 챗봇</h1>
                    <p class="text-[10px] opacity-90">민방위대피시설 정보 기반</p>
                </div>
                <div id="llm-status" class="llm-badge llm-off">LLM OFF</div>
            </header>

            <!-- 지도 영역 -->
            <div class="relative flex-1 min-h-0 overflow-hidden">
                <div id="map" class="w-full h-full transition-all duration-300"></div>

                <!-- [2026-01-06 추가] 슬라이딩 패널 토글 버튼 (지도 위에 고정) -->
                <button id="nav-toggle-btn" onclick="toggleNavDrawer()"
                    class="absolute top-4 left-4 z-[110] bg-white border border-gray-200 p-3 rounded-full shadow-lg hover:bg-gray-50 transition-all hidden"
                    title="길찾기 상세 안내 보기">
                    🛣️
                </button>

                <!-- [2026-01-06 추가] 슬라이딩 패널 (Drawer) -->
                <div id="nav-drawer"
                    class="absolute top-0 left-0 z-[100] h-full w-72 bg-white/95 backdrop-blur-md shadow-2xl border-r border-gray-200 transform -translate-x-full transition-transform duration-300 flex flex-col">

                    <div
                        class="p-4 border-b border-gray-200 bg-emerald-600 text-white flex justify-between items-center">
                        <h3 class="font-bold text-lg text-white">🚶 길찾기 상세</h3>
                        <button onclick="toggleNavDrawer()"
                            class="text-white hover:text-gray-200 text-2xl leading-none px-2">&times;</button>
                    </div>

                    <div id="nav-summary"
                        class="p-4 bg-emerald-50 border-b border-gray-100 text-sm font-bold text-center text-emerald-800 flex justify-around">
                        <p>경로 데이터를 불러오는 중...</p>
                    </div>

                    <div id="nav-list" class="flex-1 overflow-y-auto p-3 space-y-3 custom-scrollbar">
                        <div class="text-center text-gray-400 py-20 text-sm">
                            <p>🏃 대피소 검색 시 자동으로 안내가 시작됩니다.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 파노라마(로드뷰) 영역 (2026-01-06: 구조 개선) -->
            <div id="pano-container" class="w-full bg-gray-800 relative transition-all duration-300"
                style="height: 0%; overflow: hidden;">
                <!-- 실제 로드뷰가 그려질 영역 -->
                <div id="pano" class="w-full h-full"></div>

                <!-- 안내 및 컨트롤 레이어 (로드뷰 위에 덮어씌움) -->
                <div id="pano-placeholder"
                    class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm z-10">
                    📷 지도를 클릭하면 로드뷰가 표시됩니다
                </div>
                <button id="pano-close-btn" onclick="hidePanorama()"
                    class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg shadow-xl z-50 hidden transition-all"
                    title="로드뷰 닫기">
                    ✕ 닫기
                </button>
            </div>
        </div>

        <!-- right : chat -->
        <div class="flex flex-col h-[250px] md:h-[85vh] bg-white">
            <div id="chat-window" class="flex-1 min-h-0 p-6 space-y-4 overflow-y-auto bg-white">
                <div class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-4 rounded-2xl max-w-[80%] shadow-sm">
                        <p class="font-semibold mb-1">🛡️ 대피소 도우미</p>
                        <p id="initial-message">대피소 데이터를 로드하는 중입니다. 잠시만 기다려 주세요...</p>
                    </div>
                </div>
            </div>

            <!-- control panel -->
            <div id="control-panel"
                class="flex-shrink-0 p-4 bg-gray-50 border-t border-gray-300 flex flex-col gap-3 shadow-md">
                <div class="flex gap-2">
                    <button id="geo-btn" onclick="handleGeolocation()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl disabled-control"
                        disabled>📍 현위치로 찾기 (GPS)</button>
                    <button id="clear-btn" onclick="clearChatWindow()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold px-4 py-3 rounded-xl"
                        title="채팅 기록 지우기">🗑️</button>
                </div>

                <div class="flex gap-2">
                    <input id="chat-input" type="text" placeholder="주소 / 건물명 / '현위치' 입력"
                        class="flex-grow border border-gray-300 rounded-xl p-3 focus:ring-emerald-500 focus:border-emerald-500"
                        onkeydown="if(event.key==='Enter') handleChatInput()" disabled>
                    <button id="send-btn" onclick="handleChatInput()"
                        class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold px-4 rounded-xl disabled-control"
                        disabled>전송</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2026-01-06: 접속 경로(hostname)에 따라 백엔드 주소 자동 설정 로직 추가 (기존 방식은 주석 처리) -->
    <script>
        // window.FASTAPI_URL = "{{ fastapi_url }}"; // 기존: Django에서 주입받던 방식
        const currentHost = window.location.hostname;
        window.FASTAPI_URL = `http://${currentHost}:8001`;
        console.log("백엔드 연결 주소:", window.FASTAPI_URL);
    </script>

    <!-- Custom JavaScript -->
    <script src="{% static 'js/shelter.js' %}"></script>

</body>

</html>